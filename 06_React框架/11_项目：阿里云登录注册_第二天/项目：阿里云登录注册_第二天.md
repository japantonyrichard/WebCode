![logo](images\logo.png)

# 项目：阿里云登录注册_第二天

**主要内容**

* 注册界面
* 注册前后端交互
* 注册用户唯一性
* 首页界面

**学习目标**

 知识点| 要求 
 -| :- 
 注册界面 | 掌握 
 注册前后端交互 | 掌握 
 注册用户唯一性 | 掌握 
 首页界面 | 掌握 





Lodash 是一个一致性、模块化、高性能的 JavaScript 实用工具库。

安装：

npm i lodash -S



登录成功之后：

1、提示框

2、登录信息存到redux

3、持久化用户信息，存到本地  localstorage  特点：一直都存在，除非手动删除

4、跳转首页







## 一、注册界面



### 1.1 效果图

​	![logo](images\zhuce.png)



### 1.2 代码演示

```jsx
import React, { Component } from 'react'
import SignUpForm from './SignUpForm'
import * as flashActoins from "../../redux/actions/flash"
import { bindActionCreators } from "redux"
import { connect } from "react-redux"

class SignUpPage extends Component {
    render() {
        return (
            <div className="row">
                <div className="col-md-3"></div>
                <div className="col-md-6">
                    <SignUpForm flashActoins={ this.props.flashActoins }/>
                </div>
                <div className="col-md-3"></div>
            </div>
        )
    }
}

const mapDispatchToProps = (dispatch) =>{
    return{
        flashActoins:bindActionCreators(flashActoins,dispatch)
    }
}

export default connect(null,mapDispatchToProps)(SignUpPage)

```

注册表单

```jsx
import React, { Component } from 'react'
import api from "../../api"
import classnames from "classnames"
import { withRouter } from "react-router-dom"

class SignUpForm extends Component {

    constructor(){
        super();
        this.state = {
            username:"",
            password:"",
            email:"",
            passwordConfirmation:"",
            errors:{},
            ok:{}
        }
    }

    changeHandle = (e) =>{
        this.setState({
            [e.target.name]:e.target.value
        })
    }
    render() {
        const { username,email,password ,passwordConfirmation,errors,ok } = this.state;
        return (
            <div>
                <form onSubmit={ this.onSubmit }>
                    <h1>Join our community</h1>
                    <div className="form-group">
                        <label className="control-label">Username</label>
                        <input 
                            type="text"
                            className={ classnames('form-control',{ 'is-invalid':errors.username,'is-valid':ok.username}) }
                            value={ username }
                            onChange={ this.changeHandle }
                            name="username"
                            onBlur={ this.onBlurCheckUserName }
                        />
                        { errors.username ? <span style={{ color:'red',fontSize:"10px" }}>{ errors.username }</span> : '' }
                    </div>
                    <div className="form-group">
                        <label className="control-label">Email</label>
                        <input 
                            type="email"
                            className={ classnames('form-control',{ 'is-invalid':errors.email}) }
                            value={ email }
                            onChange={ this.changeHandle }
                            name="email"
                        />
                        { errors.email ? <span style={{ color:'red',fontSize:"10px" }}>{ errors.email }</span> : '' }
                    </div>
                    <div className="form-group">
                        <label className="control-label">Password</label>
                        <input 
                            type="password"
                            className={ classnames('form-control',{ 'is-invalid':errors.password}) }
                            value={ password }
                            onChange={ this.changeHandle }
                            name="password"
                        />
                        { errors.password ? <span style={{ color:'red',fontSize:"10px" }}>{ errors.password }</span> : '' }
                    </div>
                    <div className="form-group">
                        <label className="control-label">PasswordConfirmation</label>
                        <input 
                            type="password"
                            className={ classnames('form-control',{ 'is-invalid':errors.passwordConfirmation}) }
                            value={ passwordConfirmation }
                            onChange={ this.changeHandle }
                            name="passwordConfirmation"
                        />
                        { errors.passwordConfirmation ? <span style={{ color:'red',fontSize:"10px" }}>{ errors.passwordConfirmation }</span> : '' }
                    </div>
                    <div className="form-group">
                        <button className="btn btn-primary btn-lg">注册</button>
                    </div>
                </form>
            </div>
        )
    }
}

export default  withRouter(SignUpForm)
```



## 二、注册前后端交互

### 2.1 注册后台接口

```js
/**
 * 注册接口
 */

const validatorInput = (data) =>{
    let errors = {};
    if(validator.isEmpty(data.username)){
        errors.username = "用户名不能为空"
    }
    // isEmail:true不为空，false为空
    if(!validator.isEmail(data.email)){
        errors.email = "不符合邮箱格式"
    }
    if(validator.isEmpty(data.password)){
        errors.password = "密码不能为空"
    }
    /**
     * equals:比较字符串是否相等
     */
    if(!validator.equals(data.password,data.passwordConfirmation)){
        errors.passwordConfirmation = "两次密码不同"
    }
    return{
        errors,
        isValid:!isEmpty(errors)
    }
}

router.post("/register",(req,res) =>{
    /**
     * req.body = { username,password,email... }
     */
    const { errors,isValid } = validatorInput(req.body);
    if(isValid){
        // 失败了
        res.send({
            errors,
            status:400
        })
    }else{
        const { username,password,email } = req.body;
        const sql = "insert into user values (null,?,?,?)";
        const arr = [username,password,email];
        clientFn(sql,arr,result =>{
            if(result.affectedRows >0){
                res.send({
                    msg:"注册成功",
                    status:200
                })
            }else{
                res.send({
                    msg:"注册失败",
                    status:401
                })
            }
        })
    }
})

```



### 2.2 注册实现

```js
 /**
     * 注册接口
     */
    register(params){
        return axios.post(base.baseUrl + base.register,params)
    },
```



注册表单组件

```jsx
import React, { Component } from 'react'
import api from "../../api"
import classnames from "classnames"
import { withRouter } from "react-router-dom"

class SignUpForm extends Component {

    constructor(){
        super();
        this.state = {
            username:"",
            password:"",
            email:"",
            passwordConfirmation:"",
            errors:{},
            ok:{}
        }
    }

    changeHandle = (e) =>{
        this.setState({
            [e.target.name]:e.target.value
        })
    }

    onSubmit = (e) =>{
        e.preventDefault();
        api.register(this.state).then(res =>{
            console.log(res.data);
            if(res.data.status === 200){
                // 注册成功
                this.setState({
                    errors:{}
                })
                // 添加提示框
                this.props.flashActoins.addFlashMessage({
                    id:Math.random().toString().slice(2),
                    type:"success",
                    msg:"恭喜你！注册成功~"
                })
                this.props.history.push("/signin")
            }
            if(res.data.status === 400){
                // 注册失败，信息未填写
                this.setState({
                    errors:res.data.errors
                })
                // 添加提示框
                this.props.flashActoins.addFlashMessage({
                    id:Math.random().toString().slice(2),
                    type:"danger",
                    msg:"请填写用户名和密码"
                })
            }
            if(res.data.status === 401){
                // 注册失败，信息有问题
                // 添加提示框
                this.props.flashActoins.addFlashMessage({
                    id:Math.random().toString().slice(2),
                    type:"danger",
                    msg:res.data.msg
                })
            }
        })
    }

    /**
     * 用户名验证
     */
    onBlurCheckUserName = () =>{
        if(this.state.username){
            api.username({
                username:this.state.username
            }).then(res =>{
                if(res.data.status === 200){
                    if(res.data.flag){
                        // 可用
                        this.setState({
                            errors:{},
                            ok:{
                                username:"用户名可用"
                            }
                        })
                    }else{
                        // 不可用
                        this.setState({
                            errors:{
                                username:res.data.msg
                            }
                        })
                    }
                }
            })
        }
    }

    render() {
        const { username,email,password ,passwordConfirmation,errors,ok } = this.state;
        return (
            <div>
                <form onSubmit={ this.onSubmit }>
                    <h1>Join our community</h1>
                    <div className="form-group">
                        <label className="control-label">Username</label>
                        <input 
                            type="text"
                            className={ classnames('form-control',{ 'is-invalid':errors.username,'is-valid':ok.username}) }
                            value={ username }
                            onChange={ this.changeHandle }
                            name="username"
                            onBlur={ this.onBlurCheckUserName }
                        />
                        { errors.username ? <span style={{ color:'red',fontSize:"10px" }}>{ errors.username }</span> : '' }
                    </div>
                    <div className="form-group">
                        <label className="control-label">Email</label>
                        <input 
                            type="email"
                            className={ classnames('form-control',{ 'is-invalid':errors.email}) }
                            value={ email }
                            onChange={ this.changeHandle }
                            name="email"
                        />
                        { errors.email ? <span style={{ color:'red',fontSize:"10px" }}>{ errors.email }</span> : '' }
                    </div>
                    <div className="form-group">
                        <label className="control-label">Password</label>
                        <input 
                            type="password"
                            className={ classnames('form-control',{ 'is-invalid':errors.password}) }
                            value={ password }
                            onChange={ this.changeHandle }
                            name="password"
                        />
                        { errors.password ? <span style={{ color:'red',fontSize:"10px" }}>{ errors.password }</span> : '' }
                    </div>
                    <div className="form-group">
                        <label className="control-label">PasswordConfirmation</label>
                        <input 
                            type="password"
                            className={ classnames('form-control',{ 'is-invalid':errors.passwordConfirmation}) }
                            value={ passwordConfirmation }
                            onChange={ this.changeHandle }
                            name="passwordConfirmation"
                        />
                        { errors.passwordConfirmation ? <span style={{ color:'red',fontSize:"10px" }}>{ errors.passwordConfirmation }</span> : '' }
                    </div>
                    <div className="form-group">
                        <button className="btn btn-primary btn-lg">注册</button>
                    </div>
                </form>
            </div>
        )
    }
}

export default  withRouter(SignUpForm)
```



## 三、注册用户唯一性

### 3.1 效果图

​	![logo](images\tishi.png)

### 3.2 代码演示

验证输入框信息提示

```js
/**
 * 输入框是否为空的验证规则
 */
import validator from "validator"
import isEmpty from "lodash/isEmpty"

/**
 * data = {
 *  username:"",
 *  password:""
 * }
 */
const validatorInput = (data) =>{
    let errors = {};
    if(validator.isEmpty(data.username)){
        errors.username = "用户名不能为空"
    }
    if(validator.isEmpty(data.password)){
        errors.password = "密码不能为空"
    }
    return{
        isValid:!isEmpty(errors),  // 如果value为空则返回true，否则返回false
        errors
    }
}

export default validatorInput
```



### 3.3 后台接口

```js

/**
 * 用户名唯一性验证
 */
router.get("/repeat/username",(req,res) =>{
    const username = url.parse(req.url,true).query.username;
    const sql = "select * from user where username=?";
    const arr = [username];
    clientFn(sql,arr,result =>{
        if(result.length > 0){
            res.send({
                status:200,
                msg:"用户名重复",
                flag:false
            })
        }else{
            res.send({
                status:200,
                msg:"用户名可用",
                flag:true
            })
        }
    })
})


```

### 3.3 注册提示信息

```jsx
import React, { Component } from 'react'
import FlashMessage from "./FlashMessage"
import { connect } from "react-redux"
import * as flashActions from "../../redux/actions/flash"
import { bindActionCreators } from "redux"

class FlashMessageList extends Component {
    render() {
        return (
            <div>
                { 
                    this.props.flashs.map((ele,index) =>{
                        return <FlashMessage message={ ele } key={ index } flashActions={ this.props.flashActions }/>
                    })
                }
            </div>
        )
    }
}

const mapStateToProps = (state) =>{
    return{
        flashs:state.flash
    }
}

const mapDispatchToProps = (dispatch) =>{
    return{
        flashActions:bindActionCreators(flashActions,dispatch)
    }
}

export default connect(mapStateToProps,mapDispatchToProps)(FlashMessageList)
```

FlashMessage组件

```jsx
import React, { Component } from 'react'
import classnames from "classnames"

export default class FlashMessage extends Component {

    /**
     * {
     *     id:1001,
     *     msg:"登陆成功",
     *     type:"danger"
     * }
     */

    closeHandle = () => {
        // 关闭提示框:数据驱动
        this.props.flashActions.delFlashMessage(this.props.message.id)
    }

    render() {
        const message = this.props.message
        return (
            <div className={classnames('alert', {
                'alert-success': message.type === 'success',
                "alert-danger": message.type === "danger"
            })}>
                { message.msg}
                <button type="button" className="close" onClick={this.closeHandle}>
                    <span>&times;</span>
                </button>
            </div>
        )
    }
}

```

### 3.4 仓库存储

reducers

```js
import { ADD_FLASH,DEL_FALSH } from "../constants"
import findIndex from "lodash/findIndex"

const flashState = [];

const flash = (state = flashState,action) =>{
    switch(action.type){
        case ADD_FLASH:
            return[
                ...state,
                action.message   // 新的消息
            ]
        case DEL_FALSH:
            let currentIndex = findIndex(state,(item) => item.id === action.id)
            return [
                ...state.slice(0,currentIndex),
                ...state.slice(currentIndex+1)
            ];
        default:
            return state;
    }
}

export default flash
```

actions

```js
import { ADD_FLASH,DEL_FALSH } from "../constants"

export function addFlashMessage(message){
    return{
        type:ADD_FLASH,
        message
    }
}

export function delFlashMessage(id){
    return{
        type:DEL_FALSH,
        id
    }
}
```



## 四、首页界面

### 4.1 界面配置

App.jsx

```jsx
import React, { Component } from 'react'
import api from "../api"

export default class App extends Component {

    constructor() {
        super();
        this.state = {
            list: []
        }
    }

    componentDidMount() {
        api.list().then(res => {
            if (res.data.status === 200) {
                this.setState({
                    list: res.data.list
                })
            }
            if(res.data.status === 401){
                console.log("请先登陆");
            }
        })
    }

    render() {
        return (
            <div>
                {
                    this.state.list.length > 0 ?
                        <ul>
                            {
                                this.state.list.map((ele, index) => {
                                    console.log(ele);
                                    return (
                                        <li key={index}>
                                            <span>{ele.name}</span>
                                        </li>
                                    )
                                })
                            }
                        </ul> :
                        <div>等待数据加载。。。</div>
                }
            </div>
        )
    }
}

```



### 4.2 首页导航

```jsx
import React, { Component } from 'react'
import { Link } from "react-router-dom"
import { connect } from "react-redux"
import { bindActionCreators } from "redux"
import * as authActions from "../../redux/actions/auth"
import { withRouter } from "react-router-dom"
import { REACT_LOCAL_LOGIN } from "../../utils/constants"
import "./style.css"

class HeaderNav extends Component {

    logoutHandle = () => {
        /**
         * 数据清空
         *  1.redux
         *  2.本地
         */
        this.props.authActions.setUser({})
        localStorage.removeItem(REACT_LOCAL_LOGIN)
        this.props.history.replace("/signin")
    }

    render() {
        return (
            <div className="navbar navbar-expand-lg navbar-light bg-light">
                <div className="container-fluid">
                    <Link className="navbar-brand" to="/">首页</Link>
                    <div className="navbar-collapse">
                        <ul className="navbar-nav mr-auto">
                            {
                                this.props.auth.user.token ?
                                    <>
                                        <li className="nav-item">
                                            <Link className="nav-link" to="/">{  this.props.auth.user.username }</Link>
                                        </li>
                                        <li className="nav-item">
                                            <button className="btn btn-info" onClick={this.logoutHandle}>退出登陆</button>
                                        </li>
                                    </>
                                    :
                                    <>
                                        <li className="nav-item">
                                            <Link className="nav-link" to="/signin">登陆</Link>
                                        </li>
                                        <li className="nav-item">
                                            <Link className="nav-link" to="/signup">注册</Link>
                                        </li>
                                    </>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        )
    }
}

const mapStateToProps = state => {
    return {
        auth: state.auth
    }
}

const mapDispatchToProps = dispatch =>{
    return{
        authActions:bindActionCreators(authActions,dispatch)
    }
}

export default withRouter(connect(mapStateToProps,mapDispatchToProps)(HeaderNav))
```

