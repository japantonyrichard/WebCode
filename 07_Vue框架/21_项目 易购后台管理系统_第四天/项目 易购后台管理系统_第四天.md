![logo](images\logo.png)



# 项目 易购后台管理系统_第四天

**主要内容**

* 登录实现
* echarts图表
* 规格参数列表
* 添加规格参数

**学习目标**

 知识点| 要求 
 -| :- 
 登录实现 | 掌握 
 echarts图表 | 掌握 
 规格参数列表 | 掌握 
 添加规格参数 | 掌握 




## 一、登录实现

### 1.1 登录拦截

```js
import router from './index'
//获取vuex数据
import store from '../store/index'
//路由拦截
router.beforeEach((to,from,next)=>{
  //1. 判断是否需要登录
    //判断当前路由和父路由 [].some  只要有一个符合条件，及返回true
  if(to.matched.some(ele=>ele.meta.isLogin)){
      //2. 判断当前的用户是否已经登录
      let token=store.state.loginModule.userinfo.token;
      if(token){
        next()
      }else{
        next('/login')
      }
  }else{// 不需要登录
    next();
  }
})
```



### 1.2 登录vuex存储

```js
export default {
    namespaced:true,
    state:{
        userinfo:{
            user:'',
            token:''
        }
    },
    mutations:{
        //设置用户信息
        setUser(state,payload){
            state.userinfo = payload;
        },
        //清空
        clearUser(state){
            state.userinfo={
                user:'',
                token:''  
            }
        }
    },
    actions:{

    },
    getters:{

    }

}
```



### 1.3 登录界面

​	![logo](images\login.png)



### 1.4 登录代码演示

```vue
<template>
  <div class="wrapper">
    <div class="login-box">
      <div class="logo">
        <img src="../../assets/logo.png" height="120px" alt="">
      </div>
      <!-- <h3 class="title">登录界面</h3> -->
      <div>{{ info }}</div>
      <el-form
        :model="loginForm"
        status-icon
        :rules="rules"
        ref="ruleForm"
        label-width="60px"
        class="demo-ruleForm"
      >
        <el-form-item label="账号" prop="username">
          <el-input
            type="text"
            v-model="loginForm.username"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="密码" prop="password">
          <el-input
            type="password"
            v-model="loginForm.password"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="submitForm('ruleForm')"
            >提交</el-button
          >
          <el-button @click="resetForm('ruleForm')">重置</el-button>
        </el-form-item>
      </el-form>
    </div>
  </div>
</template>

<script>
import jwt from 'jwt-decode'
import {mapMutations} from 'vuex'
 export default {
    data() {
      var validateUser = (rule, value, callback) => {
        if (value === '') {
          callback(new Error('请输入账号'));
        } else {
          callback();
        }
      };
      var validatePass = (rule, value, callback) => {
        if (value === '') {
          callback(new Error('请输入密码'));
        } else {
          callback();
        }
      };
      return {
        info:'',
        loginForm: {
          username: '',
          password: '',
        },
        rules: {
          username: [
            { validator: validateUser, trigger: 'blur' }
          ],
          password: [
            { validator: validatePass, trigger: 'blur' }
          ],
        }
      };
    },
    methods: {
      ...mapMutations('loginModule',['setUser']),
      submitForm(formName) {
        this.$refs[formName].validate((valid) => {
          if (valid) {
            let { username,password} = this.loginForm;
            //请求登录接口------------- 
            this.$api.getLogin({
              username,password
            }).then(res=>{
              console.log('-----',res.data);
              if(res.data.status===200){
                console.log(jwt(res.data.data));
                //登录成功后：1. 存储登录信息  2. 跳转网页 3. 顶部区域显示用户信息  4. 持久化
                let obj ={
                  user:jwt(res.data.data).username,
                  token:res.data.data
                }
                this.setUser(obj)
                //存储本地
                localStorage.setItem('user',JSON.stringify(obj))
                //跳转
                this.$router.push('/')
                // this.info=''

              }else{
                //账号或者密码错误
                // this.info='账号或者密码错误'
                 this.$message.error('错了哦，这是一条错误消息');
              }
            })


          } else {
            console.log('error submit!!');
            return false;
          }
        });
      },
      resetForm(formName) {
        this.$refs[formName].resetFields();
      }
    }
  }
</script>

<style lang='less' scoped>
.wrapper{
  position: fixed;
  left: 0;
  top: 0;
  bottom: 0;
  right: 0;
  background: #104468;
}
.login-box {
  width: 400px;
  height: 260px;
  padding: 20px;
  margin: 0 auto;
  margin-top: 180px;
  border-radius: 10px;

  border: 1px solid #eee;
  background: #fff;
  position: relative;
}
.logo{
  position: absolute;
  width: 120px;
  height: 120px;
  background: #f7f7f7;
  border-radius: 50%;
  overflow: hidden;
  top:-80px;
  left:50%;
  margin-left: -60px;
  padding:8px;
  img{
    border-radius: 50%;
    background: #fff;
  }
}
.demo-ruleForm{
  margin-top: 60px;
}
.title{
  margin-bottom: 30px;
  text-align: center;
  color: #666;
}

</style>
```

### 1.5 登录接口

前端解密：jwt-decode

1. 安装

   ```bash
   npm i jwt-decode -S
   ```

2. 引入

   ```js
   import jwt from 'jwt-decode'
   ```

   

#### 持久化的目的：

Vuex一刷新就丢失，只有存到本地，  ==>从本地取出来，再存到Vuex里

为什么要用Vuex?

需要共享的数据放到Vuex.  token

beforeEach  token  next()

main.js:  从本地取出来，再存到Vuex里  



#### 从本地取出来，再存到Vuex里  

main.js:

```js
// 第一种方式：
let userinfo = localStorage.getItem('user');
if (userinfo) {
  //  从本地取出来，再存到Vuex里==>修改state里的数据
  store.commit('userModule/setUser', JSON.parse(userinfo))
}

```

 第2种方式：userModule.js: 

```js
// 存放所有需要共享的状态
const state = {
    userinfo: {
        // username:(localStorage.getItem('userinfo')&&JSON.parse(localStorage.getItem('userinfo')).username) ||'',
        username: localStorage.getItem('user')?JSON.parse(localStorage.getItem('user')).username:'', //用户名
        token: localStorage.getItem('user')?JSON.parse(localStorage.getItem('user')).token:'' //登陆信息
    },

}
```













```js

/**
 * 登录 login
 * 接受的字段：username,password
 * 测试：postman  
 */
 router.post('/login', (req, res) => {
    let {username,password} = req.body
    //请求数据库
    let sql = "select * from userinfo where username=? and password=?";
    let arr = [username, password]
    sqlFn(sql, arr, result => {
        if (result.length > 0) {
            let token = jwt.sign({
                username: result[0].username,
                id: result[0].id
            }, config.jwtSecert, {
                expiresIn: 20 * 1
            })
            res.send({
                status: 200,
                data: token
            })
        } else {
            res.send({
                status: 404,
                msg: '信息错误'
            })
        }

    })
})
```

### 1.6 注册接口

```js

/**
 * 注册接口 /register
 */
router.post("/register", (req, res) => {
    const {
        username,
        password
    } = req.body;
    const sql = "insert into userinfo values(null,?,?)";
    const arr = [username, password];
    sqlFn(sql, arr, (result) => {
        if (result.affectedRows > 0) {
            res.send({
                msg: "注册成功",
                status: 200
            })
        } else {
            res.status(401).json({
                errors: "用户名密码错误"
            })
        }
    })
})

```



## 二、Echarts图表

### 2.1 效果图

​	![logo](images\home.png)



### 2.2 代码演示

```vue
<template>
  <div class="home">
    <!-- 顶部区域 -->
    <div class="header">
      <div class="item" v-for="item in totalData" :key="item.id">
        {{ item.title }}
        <div class="num">{{ item.total }}</div>
        <div class="bottom">今日销售额: {{ item.current }}</div>
      </div>
    </div>

    <!-- 访问时长 -->
    <div class="content">
      <div class="time-info">
        <div class="title">月销售额</div>
        <div id="charts" style="width: 100%; height: 360px"></div>
      </div>
      <div class="area">地区分布</div>
    </div>

    <!-- 最新内容 -->
    <div class="home-footer">
      <el-card class="box-card">
        <div slot="header" class="clearfix">
          <span>最新内容</span>
        </div>
        <div v-for="o in 4" :key="o" class="text item">
          {{ "列表内容 " + o }}
        </div>
      </el-card>
      <el-card class="box-card">
        <div slot="header" class="clearfix">
          <span>新增产品</span>
        </div>
        <div v-for="o in 4" :key="o" class="text item">
          {{ "列表内容 " + o }}
        </div>
      </el-card>
      <el-card class="box-card">
        <div slot="header" class="clearfix">
          <span>快捷入口</span>
        </div>
        <div class="text item">
          <el-button type="primary">产品管理</el-button>
          <el-button>消息管理</el-button>
          <el-button>内容管理</el-button>
        </div>
      </el-card>
    </div>
  </div>
</template>

<script>
export default {
  data() {
    return {
      totalData: [],
    };
  },
  mounted() {
    console.log("this.$echarts.init", this.$echarts);
    console.log(document.getElementById("charts"));

    //进度
    //销售数据量
    this.$api.getStatistical().then((res) => {
      console.log("销售数据量", res.data);
      //totalData
      if (res.data.status === 200) {
        this.totalData = res.data.list;
      }
    });
    //--销售比----------------------
    this.$api.getSellTotal().then((res) => {
      console.log(res.data);
      //获取x轴数据
      let xData = res.data.info.date;
      //获取数据
      let xResult = res.data.info.xResult;
      let titleArr = [];
      let data =[]

      xResult.forEach((ele) => {
        titleArr.push(ele.xName);
        ele.data.forEach(item=>{
          data.push(item.num)
        })
      });
      //折线 
      this.initCharts(xData,data.slice(0,6),data.slice(6,12),data.slice(12,18));
    });
  },
  methods: {
    //折线图
    initCharts(data,data1,data2,data3) {
      let charts = this.$echarts.init(document.getElementById("charts"));
      let option = {
        tooltip: {
          trigger: "axis",
          axisPointer: {
            type: "cross",
            label: {
              backgroundColor: "#6a7985",
            },
          },
        },
        legend: {
          data: ["家具", "手机","家电"],
          left:100,
        },
        toolbox: {
          feature: {
            saveAsImage: {},
          },
        },
        grid: {
          left: "3%",
          right: "4%",
          bottom: "3%",
          containLabel: true,
        },
        xAxis: [
          {
            type: "category",
            boundaryGap: false,
            data,
          },
        ],
        yAxis: [
          {
            type: "value",
          },
        ],
        series: [
          {
            name: "家具",
            type: "line",
            smooth: true,
            areaStyle: {},
            emphasis: {
              focus: "series",
            },
            data:data1,
          },
          {
            name: "手机",
            type: "line",
            smooth: true,
            areaStyle: {},
            emphasis: {
              focus: "series",
            },
            data: data2,
          },
          {
            name: "家电",
            type: "line",
            smooth: true,
            areaStyle: {},
            emphasis: {
              focus: "series",
            },
            data: data3,
          },
        ],
      };
      charts.setOption(option);
    },
  },
};
</script>

<style lang='less' scoped>
.home{
  margin: 10px;
}
.header {
  display: flex;
  padding-right: 30px;
  .item {
    flex: 1;
    height: 100px;
    padding: 10px;
    background: #fff;
    border-radius: 10px;
    margin-left: 20px;
    margin-right: 20px;
    font-weight: bold;
    color: #fff;
    // text-align: center;
    position: relative;
    .num {
      font-size: 22px;
      margin: 10px;
          color: #fff;
    }
    .bottom {
      position: absolute;
      border-top: 1px solid rgb(246, 245, 245);
      padding: 10px 20px;
      bottom: 0;
      right: 0;
      left: 0;
          color: #fff;
          font-weight: normal;
    }
  }
   .item:nth-child(1){
    background-image: linear-gradient(#df887d, #88554d);
  }
  .item:nth-child(2){
    background-image: linear-gradient(#409eff, #2e556e);
  }
   .item:nth-child(3){
    background-image: linear-gradient(#b54fa8, #713c7a);
  }
   .item:nth-child(4){
    background-image: linear-gradient(#1cd2f1, #39717a);
  }
}
.content {
  margin: 20px;
  display: flex;
  height: 400px;
  .time-info {
    flex: 2;
    background: #fff;
    margin-right: 20px;
    padding: 10px;
  }
  .area {
    flex: 1;
    background: #fff;
    padding: 10px;
  }
}
.home-footer {
  display: flex;
  padding-left: 20px;
  margin-bottom:20px;
  .box-card {
    flex: 1;
    margin-right: 30px;
    span {
      font-weight: 600;
    }
  }
}
</style>
```

### 2.3 接口数据

```js

/**
 * 统计数据--销售信息
 */
router.get('/statistical', (req, res) => {
    res.send(Mock.mock({
        success: true,
        status: 200,
        "list|4": [
            {
                'id|+1': 100,
                "title|+1": ['总销售额', '访问量', '支付总量', '收藏量'],
                "current|0-2000": 100,
                "total|100-999999": 200
            }
        ]
    }))
})

/**
 * 统计 半年 月销量对比数据
 * 月度销售额
 */

router.get('/sellTotal', (req, res) => {
    res.send(Mock.mock({
        success: true,
        status: 200,
        info: {
            'id|+1': 100,
            date: function () {
                var category = [];
                var dottedBase = +new Date();
                for (var i = 30; i > 0; i--) {
                    var date = new Date((dottedBase -= 1000 * 3600 * 24 * 30));
                    category.push([date.getFullYear(), date.getMonth() + 1].join("-"));
                }
                return category.slice(0, 6);
            },
            "xResult|3": [
                {
                    'xName|+1': ["家具", '手机', '家电'],
                    "data|6": [
                        { 'num|100-1000': 10 }
                    ]

                },
            ],
        }
    }))
})

```



## 三、规格参数列表

### 3.1 效果图

​	![logo](images\guige.png)



### 3.2 代码演示

```vue
<template>
  <div class="params">
    <!-- 1. 目录位置 -->
    <div class="nav">
      <el-breadcrumb separator="/">
        <el-breadcrumb-item :to="{ path: '/' }">首页</el-breadcrumb-item>
        <el-breadcrumb-item :to="{ path: '/params' }"
          >规格参数</el-breadcrumb-item
        >
        <el-breadcrumb-item>规格包装</el-breadcrumb-item>
      </el-breadcrumb>
    </div>
    <!-- 2. 搜索框 -->
    <div class="header">
      <el-input v-model="inp" />
      <el-button type="primary">查看</el-button>
      <el-button type="primary" @click="showParams">添加</el-button>
    </div>

    <!-- 3. 表格 -->
    <el-table :data="tableData" class="my-table">
      <el-table-column prop="itemCatId" label="规格参数ID" width="120">
      </el-table-column>
      <el-table-column prop="id" label="类目ID" width="120"> </el-table-column>
      <el-table-column prop="specsName" label="规格名称" width="120">
      </el-table-column>
      <el-table-column prop="paramData" label="规格参数" show-overflow-tooltip>
      </el-table-column>
      <el-table-column label="操作" width="280">
        <template>
          <el-button size="mini">查看</el-button>
          <el-button type="primary" size="mini" icon="el-icon-edit">
            编辑</el-button
          >
          <el-button size="mini" type="danger" icon="el-icon-delete"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>

    <!-- 4. 分页 -->
    <MyPagination
      :total="total"
      :pageSize="pageSize"
      @changePage="changePage"
    />
    <!-- 5. 弹框 -->
    <ParamsDialog ref='dialog'/>

  </div>
</template>

<script>
import MyPagination from "../../../components/MyPagination.vue";
import ParamsDialog from './ParamsDialog.vue'
export default {
  components: {
    MyPagination,
    ParamsDialog
  },
  data() {
    return {
      inp: "", //输入框
      tableData: [],
      total: 10,
      pageSize: 1,
    };
  },
  methods: {
    /**
     * 点击显示弹框--配置规格参数
     */
    showParams(){
      this.$refs.dialog.dialogVisible= true;
    },
    /**
     * 点击分页-切换
     */
    changePage(num) {
      this.http(num);
    },
    /**
     * 获取规格参数列表
     */
    http(page) {
      this.$api.getParams({ page }).then((res) => {
        console.log(res.data);
        if (res.data.status === 200) {
          this.tableData = res.data.data;
          //获取分页
          this.total = res.data.total;
          this.pageSize = res.data.pageSize;
        }
      });
    },
  },
  created() {
    this.http(1);
  },
};
</script>

<style lang='less' scoped>
.params {
  margin: 10px;
}
.nav {
  padding: 10px;
}
.header {
  display: flex;
  background: #fff;
  padding: 10px;
  border: 1px solid #eee;
  button {
    margin-left: 20px;
  }
}
.my-table {
  margin: 10px auto;
}
</style>
```



### 3.3 规格接口

```js


/**
 * 规格参数列表  参数 page
 */
router.get("/backend/itemParam/selectItemParamAll", (req, res) => {
    const page = req.query.page || 1;
    const sqlLen = "select * from params where id";
    sqlFn(sqlLen, null, data => {
        let len = data.length;
        const sql = "select * from params order by id desc limit 8 offset " + (page - 1) * 8;
        sqlFn(sql, null, result => {
            if (result.length > 0) {
                res.send({
                    status: 200,
                    data: result,
                    pageSize: 8,
                    total: len
                })
            } else {
                res.send({
                    status: 500,
                    msg: "暂无数据"
                })
            }
        })
    })
})

/**
 * 规格参数  模糊查询  参数：search
 */
router.get("/params/search", (req, res) => {
    var search = req.query.search;
    const sql = "select * from params where concat(`paramData`) like '%" + search + "%'";
    sqlFn(sql, [search], result => {
        if (result.length > 0) {
            res.send({
                status: 200,
                result
            })
        } else {
            res.send({
                status: 500,
                msg: '暂无数据'
            })
        }
    })
})

```



## 四、添加规格参数

### 4.1 效果图



title:标题,，规格类别

value:不需要填写，添加商品的时候填写

chidren:你下面子级

​	![logo](images\tan.png)

### 4.2 代码演示

```vue
<template>
  <el-dialog title="添加规格参数" :visible.sync="dialogVisible" width="50%">
    <!-- 显示规格类目 -->
    <TreeGoods @sendTreeData="sendTreeData" />
    <span slot="footer" class="dialog-footer">
      <el-button @click="dialogVisible = false">取 消</el-button>
      <el-button
        type="primary"
        @click="innerVisible = true"
        :disabled="isDisabled"
        >确定并添加分组</el-button
      >
    </span>
    <!-- 二级弹框---嵌套 -->
    <el-dialog
      width="45%"
      title="商品规格参数配置"
      :visible.sync="innerVisible"
      append-to-body
    >
      <div class="title">当前选中的商品：{{ treeData.name }}</div>
      <el-button type="primary" style="margin: 10px" @click="addDomain"
        >新增规格列表</el-button
      >
      <hr />
      <el-form
        :model="dynamicValidateForm"
        ref="dynamicValidateForm"
        label-width="120px"
        class="demo-dynamic"
      >
        <!-- groups=[{title:'',value:'',children:[]},...] -->
        <el-form-item
          v-for="(item, index) in dynamicValidateForm.groups"
          :label="item.title + index"
          :key="index"
          :prop="item.title"
          :rules="{ required: true, message: '域名不能为空', trigger: 'blur' }"
        >
          <div class="item">
            <el-input v-model="item.title"></el-input>
            <el-button @click.prevent="addChildDomain(index)"
              >增加子组</el-button
            >
            <el-button @click.prevent="removeDomain(index)">删除</el-button>
          </div>
          <!-- 内层的表单项 -->
          <el-form-item
            v-for="(ele, i) in item.children"
            :label="ele.title + i"
            :key="i"
            :prop="ele.title"
            :rules="{
              required: true,
              message: '域名不能为空',
              trigger: 'blur',
            }"
          >
            <div class="item">
              <el-input v-model="ele.title"></el-input>
              <el-button @click.prevent="removeChildDomain(index, i)"
                >删除</el-button
              >
            </div>
          </el-form-item>
        </el-form-item>
      </el-form>

      <span slot="footer" class="dialog-footer">
        <el-button  type="primary" @click="submitForm('dynamicValidateForm')">确定</el-button>
        <el-button @click="resetForm('dynamicValidateForm')">重置</el-button>
      </span>
    </el-dialog>
  </el-dialog>
</template>

<script>
import TreeGoods from "../../Goods/GoodsList/TreeGoods.vue";
export default {
  components: {
    TreeGoods,
  },
  data() {
    return {
      dialogVisible: false,
      innerVisible: false,
      isDisabled: true, //默认不可以点击
      treeData: {}, //tree数据
      dynamicValidateForm: {
        //动态表单
        groups: [],
      },
    };
  },
  methods: {
    /**
     * 获取点击的tree的数据
     */
    sendTreeData(val) {
      console.log("获取tree的数据", val);
      this.treeData = val;
      this.isDisabled = false;
    },
    /**
     * 增加子组
     */
    addChildDomain(index) {
      this.dynamicValidateForm.groups[index].children.push({
        value: "",
        title: "",
      });
    },
    /**
     * 删除当前的组
     */
    removeDomain(index) {
      this.dynamicValidateForm.groups.splice(index, 1);
    },
    /**
     * 删除子组
     */
    removeChildDomain(index, i) {
      this.dynamicValidateForm.groups[index].children.splice(i, 1);
    },
    /**
     * 新增列表---增加大组说明规格配置
     */
    addDomain() {
      this.dynamicValidateForm.groups.push({
        title: "",
        value: "",
        children: [],
      });
    },
    /**
     * 提交事件
     */
      submitForm(formName) {
      this.$refs[formName].validate((valid) => {
        if (valid) {
          console.log('提交规格参数',this.dynamicValidateForm.groups);
          // 参数：itemCatId,content,specsName
          this.$api.insertItemParam({
              itemCatId:this.treeData.cid,
              specsName:this.treeData.name,
              content:JSON.stringify(this.dynamicValidateForm.groups),
          })
          .then(res=>{
              console.log('====',res.data);
              if(res.data.status===200){
                  //添加成功  隐藏弹框 更新规格列表
                  this.innerVisible = false;
                  this.dialogVisible = false; 
                  //清空数据
                  this.dynamicValidateForm.groups=[];
                  this.isDisabled = true;
                  this.$parent.http(1);
              }else{
                  console.log('信息提示--失败了--缺点：数据库没有去重');
              }
          })

        } else {
          console.log("error submit!!");
          return false;
        }
      });
    },
    /**
     * 重置
     */
    resetForm(formName) {
      this.$refs[formName].resetFields();
    },
  },
};
</script>

<style lang='less' scoped>
.demo-dynamic {
  margin: 10px;
}
.item {
  display: flex;
  margin-bottom: 10px;
  button {
    margin-left: 10px;
  }
}
</style>
```

### 4.3 规格相关接口

```js

/**
 * 规格参数 添加 
 * 参数：itemCatId,content,specsName
 */
router.get("/backend/itemParam/insertItemParam", (req, res) => {
    var itemCatId = req.query.itemCatId;
    var paramsContent = req.query.content;
    var specsName = req.query.specsName;
    // console.log(itemCatId, paramsContent,specsName);
    var sql = "insert into params values (null,?,?,?)";
    sqlFn(sql, [itemCatId, paramsContent, specsName], result => {
        if (result.affectedRows > 0) {
            res.send({
                status: 200,
                msg: "添加成功"
            })
        } else {
            res.send({
                status: 500,
                msg: "添加失败"
            })
        }
    })
})


/**
 * 修改规格参数 cid content id  specsName
 */
router.get("/update/category", (req, res) => {
    var cid = req.query.cid;
    var content = req.query.content;
    var id = req.query.id;
    var specsName = req.query.specsName;
    var sql = "update params set paramData=? ,itemCatId=?,specsName=? where id=?";
    sqlFn(sql, [content, cid, specsName, id], result => {
        if (result.affectedRows > 0) {
            res.send({
                status: 200,
                msg: "修改成功"
            })
        } else {
            res.send({
                status: 500,
                msg: "修改失败"
            })
        }
    })
})

/**
 * 规格参数删除
 */
router.get("/params/delete", (req, res) => {
    var id = req.query.id;
    const sql = "delete from params where id=?"
    const arr = [id];
    sqlFn(sql, arr, result => {
        if (result.affectedRows > 0) {
            res.send({
                status: 200,
                msg: "删除成功"
            })
        } else {
            res.send({
                status: 500,
                msg: "删除失败"
            })
        }
    })
})
```

